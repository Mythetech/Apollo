@using System.Reflection
@using Apollo.Components.Analysis
@using Apollo.Components.Code
@using Apollo.Components.Console
@using Apollo.Components.Hosting
@using Apollo.Components.Infrastructure.Keyboard
@using Mythetech.Framework.Infrastructure.MessageBus
@using Apollo.Components.Settings.Attributes
@using Apollo.Components.Settings.Events
@using Apollo.Components.Shared
@using Apollo.Components.Theme
@using Apollo.Components.Shared.ApolloSwitch
@using Microsoft.JSInterop
@using Apollo.Components.Shared
@implements IDisposable

<MudDialog Class="pa-4 glassmorphic" >
    <DialogContent>
        <MudGrid Style="height: 100%;">
            <MudItem xs="12">
                <MudText Class="app-header-font" Typo="Typo.h5">Settings</MudText>
            </MudItem>
            
            <MudItem xs="3" Style="border-right: 1px solid var(--mud-palette-lines-default); height: calc(80vh - 120px); overflow-y: auto;">
                <MudNavMenu Dense Color="Color.Secondary" Style="width: 90%">
                    @foreach (var settingSection in _sections)
                    {
                        <SettingsNavLink Icon="@(settingSection.Icon)"
                                    LinkClass="@($"{(_activeSection == settingSection.Id ? "active " : "")}rounded")"
                                    OnClick="@(() => ScrollToSection(settingSection.Id))">
                               @settingSection.Name
                        </SettingsNavLink>
                    }
                </MudNavMenu>
            </MudItem>
            
            <MudItem xs="9" id="settings-scroll-container" Style="height: calc(80vh - 120px); overflow-y: auto;" Class="d-flex flex-column gap-12">
                <SettingsSectionDisplay Id="section-appearance" Title="Color Mode">
                    <MudToggleGroup T="ThemeMode"
                                    Value="@Settings.ThemeMode"
                                    ValueChanged="@(value => Settings.ThemeMode = value)"
                                    Color="Color.Secondary"
                                    Class="d-flex mud-width-full">
                        <MudToggleItem Class="flex-grow-1" Value="@(ThemeMode.Light)">
                            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Row Class="flex-grow-1 mud-width-full">
                                <MudIcon Icon="@Icons.Material.TwoTone.LightMode" Class="mr-2"/>
                                <MudText Style="@(Settings.ThemeMode == ThemeMode.Light ? "opacity: 1" : "opacity: 0.7")">
                                    Light
                                </MudText>
                            </MudStack>
                        </MudToggleItem>
                        <MudToggleItem Class="flex-grow-1" Value="@(ThemeMode.Dark)">
                            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Row Class="flex-grow-1 mud-width-full">
                                <MudIcon Icon="@Icons.Material.TwoTone.NightlightRound" Class="mr-2"/>
                                <MudText Style="@(Settings.ThemeMode == ThemeMode.Dark ? "opacity: 1" : "opacity: 0.7")">
                                    Dark
                                </MudText>
                            </MudStack>
                        </MudToggleItem>
                        <MudToggleItem Class="flex-grow-1" Value="@(ThemeMode.System)">
                            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Row Class="flex-grow-1 mud-width-full">
                                <MudIcon Icon="@Icons.Material.TwoTone.Computer" Class="mr-2"/>
                                <MudText Style="@(Settings.ThemeMode == ThemeMode.System ? "opacity: 1" : "opacity: 0.7")">
                                    System
                                </MudText>
                            </MudStack>
                        </MudToggleItem>
                    </MudToggleGroup>
                </SettingsSectionDisplay>
                
                <SettingsSectionDisplay Id="section-themes" Title="Built-in Themes">
                    <MudToggleGroup T="string" 
                                    Value="@GetCurrentThemeValue()"
                                    ValueChanged="@OnThemeSelected"
                                    Class="mud-width-full" 
                                    SelectedClass="box-shadow-primary"
                                    Style="border:none!important;">
                        <MudToggleItem Value="@("Apollo")" Class="rounded">
                            <ThemeCard 
                                Title="Apollo"
                                Description="Solar-inspired with golden accents"
                                ChipText="Default"
                                IsSelected="@(Settings.CurrentTheme.Name == "Apollo" && !Settings.IsUsingCustomTheme)"
                                CardTheme="@ApolloTheme.Instance.Theme.BaseTheme"/>
                        </MudToggleItem>
                        <MudToggleItem Value="@("Stealth")" Class="rounded">
                            <ThemeCard 
                                Title="Stealth"
                                Description="Minimalist flat design"
                                ChipText="Stealth"
                                IsSelected="@(Settings.CurrentTheme.Name == "Stealth" && !Settings.IsUsingCustomTheme)"
                                CardTheme="@StealthTheme.Instance.Theme.BaseTheme"/>
                        </MudToggleItem>
                        <MudToggleItem Value="@("Siren")" Class="rounded">
                            <ThemeCard
                                Title="Siren"
                                Description="Siren's signature blue theme"
                                ChipText="Siren"
                                IsSelected="@(Settings.CurrentTheme.Name == "Siren" && !Settings.IsUsingCustomTheme)"
                                CardTheme="@SirenTheme.Instance.Theme.BaseTheme"/>
                        </MudToggleItem>
                    </MudToggleGroup>
                </SettingsSectionDisplay>
                
                <SettingsSectionDisplay Id="section-custom-themes" Title="Custom Themes">
                    <HeaderContent>
                        <MudStack Row Spacing="2">
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" StartIcon="@Icons.Material.TwoTone.ContentPaste" OnClick="ImportTheme">
                                Import
                            </MudButton>
                            @if (Settings.CustomThemes.Themes.Count > 0)
                            {
                                <MudButton Size="Size.Small" Variant="Variant.Outlined" StartIcon="@ApolloIcons.Export" OnClick="ExportAllThemes">
                                    Export All
                                </MudButton>
                            }
                            <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@ApolloIcons.Add" OnClick="CreateNewTheme">
                                New Theme
                            </MudButton>
                        </MudStack>
                    </HeaderContent>
                    <ChildContent>
                        @if (Settings.CustomThemes.Themes.Count == 0)
                    {
                        <MudPaper Class="pa-4 d-flex flex-column align-center justify-center" Elevation="0" Style="background: var(--mud-palette-dark); min-height: 100px;">
                            <MudIcon Icon="@Icons.Material.TwoTone.Palette" Size="Size.Large" Class="mb-2 mud-text-secondary" />
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">No custom themes yet</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Create or import a theme to get started</MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudToggleGroup T="string" 
                                        Value="@GetCurrentThemeValue()"
                                        ValueChanged="@OnThemeSelected"
                                        Class="mud-width-full" 
                                        SelectedClass="box-shadow-primary"
                                        Style="border:none!important;">
                            @foreach (var customTheme in Settings.CustomThemes.Themes.Values)
                            {
                                <MudToggleItem Value="@($"custom:{customTheme.Data.Id}")" Class="rounded">
                                    <CustomThemeCard 
                                        Theme="@customTheme" 
                                        IsSelected="@(Settings.CurrentCustomThemeId == customTheme.Data.Id)"
                                        OnEdit="@(() => EditTheme(customTheme))"
                                        OnExport="@(() => ExportTheme(customTheme))" />
                                </MudToggleItem>
                            }
                        </MudToggleGroup>
                        }
                    </ChildContent>
                </SettingsSectionDisplay>

                <SettingsSectionDisplay Id="section-console" Title="Console">
                    <ApolloSwitch LabelPlacement="Placement.Left" Color="Color.Secondary" Label="Autoscroll when console input received" @bind-Value="ConsoleOutputService.AutoScroll" />
                </SettingsSectionDisplay>

                <SettingsSectionDisplay Id="section-code-analysis" Title="Code Analysis">
                    <ApolloSwitch 
                        LabelPlacement="Placement.Left" 
                        Color="Color.Secondary" 
                        Label="Enable code analysis features (completions, diagnostics)" 
                        @bind-Value="@_codeAnalysisEnabled" />
                    <ApolloSwitch
                        LabelPlacement="Placement.Left"
                        Color="Color.Secondary"
                        Label="Autoscroll when code analysis input received"
                        @bind-Value="CodeAnalysisConsoleService.AutoScroll" />
                </SettingsSectionDisplay>

                <SettingsSectionDisplay Id="section-web-application" Title="Web Application">
                    <MudStack>
                        <ApolloSwitch 
                            LabelPlacement="Placement.Left" 
                            Color="Color.Secondary" 
                            Label="Autoscroll when web host output received" 
                            @bind-Value="WebHostConsoleService.AutoScroll" />
                    </MudStack>
                </SettingsSectionDisplay>

                <SettingsSectionDisplay Id="section-keybindings" Title="Keyboard Shortcuts">
                    <HeaderContent>
                        <MudButton Size="Size.Small" 
                                   Variant="Variant.Outlined" 
                                   StartIcon="@ApolloIcons.Reset" 
                                   OnClick="ResetKeybindings">
                            Reset to Defaults
                        </MudButton>
                    </HeaderContent>
                    <ChildContent>
                        <MudStack Spacing="1">
                            @foreach (var binding in KeyBindingsState.KeyBindings)
                            {
                                <KeyBindingRow Binding="@binding" 
                                               OnBindingChanged="OnKeybindingChanged" 
                                               OnDelete="OnKeybindingDeleted"
                                               CanDelete="@(!KeyBindingsState.IsDefaultBinding(binding))" />
                            }
                            <MudDivider Class="my-2" />
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Secondary" 
                                       StartIcon="@ApolloIcons.Add"
                                       OnClick="AddNewKeybinding">
                                Add Keybinding
                            </MudButton>
                        </MudStack>
                    </ChildContent>
                </SettingsSectionDisplay>
            
                @foreach (var settingsGroup in Settings.GetSettingsModels())
                {
                    <SettingsSectionDisplay Id="@GetSectionId(settingsGroup.Section)" Title="@settingsGroup.Section">
                        <MudStack>
                            @foreach (var property in settingsGroup.Type.GetProperties().Where(p => p.GetCustomAttribute<SettingAttribute>() != null))
                            {
                                var label = property.GetCustomAttribute<SettingAttribute>()?.Label;
                                
                                if (property.PropertyType == typeof(bool))
                                {
                                    <ApolloSwitch
                                        LabelPlacement="Placement.Left"
                                        Color="Color.Secondary"
                                        Label="@label"
                                        Value="@((bool)property.GetValue(settingsGroup)!)"
                                        ValueChanged="@(async (bool value) => { property.SetValue(settingsGroup, value); await Bus.PublishAsync(new SettingsModelChanged(settingsGroup.Type, settingsGroup)); })"/>
                                }
                                else if (property.PropertyType == typeof(int))
                                {
                                    <MudNumericField
                                        T="int"
                                        Label="@label"
                                        Variant="Variant.Text"
                                        Value="@((int)property.GetValue(settingsGroup)!)"
                                        ValueChanged="@(async (int value) => { property.SetValue(settingsGroup, value); await Bus.PublishAsync(new SettingsModelChanged(settingsGroup.Type, settingsGroup)); })"/>
                                }
                                else if (property.PropertyType.IsEnum)
                                {
                                    <MudSelect
                                        T="string"
                                        Label="@label"
                                        Variant="Variant.Text"
                                        Value="@(property.GetValue(settingsGroup)!.ToString())"
                                        ValueChanged="@(async (string value) => { property.SetValue(settingsGroup, Enum.Parse(property.PropertyType, value)); await Bus.PublishAsync(new SettingsModelChanged(settingsGroup.Type, settingsGroup)); })">
                                        @foreach (var enumValue in Enum.GetNames(property.PropertyType))
                                        {
                                            <MudSelectItem Value="@enumValue">@enumValue</MudSelectItem>
                                        }
                                    </MudSelect>
                                }
                            }
                        </MudStack>
                    </SettingsSectionDisplay>
                }
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudStack Row="true" Spacing="4" Class="mud-width-full" AlignItems="AlignItems.Center">
            <MudSpacer/>
            <MudButton Class="rounded" OnClick="Cancel">Close</MudButton>
        </MudStack>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Inject] private SettingsState Settings { get; set; } = default!;
    [Inject] private ConsoleOutputService ConsoleOutputService { get; set; } = default!;
    [Inject] private CodeAnalysisState CodeAnalysisState { get; set; } = default!;
    [Inject] private WebHostConsoleService WebHostConsoleService { get; set; } = default!;
    [Inject] private CodeAnalysisConsoleService CodeAnalysisConsoleService { get; set; } = default!;
    [Inject] private IMessageBus Bus { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private IJSRuntime JsRuntime { get; set; } = default!;
    [Inject] private IScrollManager ScrollManager { get; set; } = default!;
    [Inject] private KeyBindingsState KeyBindingsState { get; set; } = default!;
    
    private IJSObjectReference? _jsModule;
    private DotNetObjectReference<SettingsDialog>? _dotNetRef;
    private string _activeSection = "section-appearance";
    
    private record SettingsSection(string Id, string Name, string Icon);
    
    private List<SettingsSection> _sections = [];
    
    private bool _codeAnalysisEnabled
    {
        get => !CodeAnalysisState.Disabled;
        set => CodeAnalysisState.Disabled = !value;
    }
    
    protected override void OnInitialized()
    {
        Settings.CustomThemes.OnThemesChanged += OnThemesChanged;
        BuildSectionsList();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _jsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Apollo.Components/app.js");
            _dotNetRef = DotNetObjectReference.Create(this);
            var sectionIds = _sections.Select(s => s.Id).ToArray();
            await _jsModule.InvokeVoidAsync("setupScrollSpy", _dotNetRef, "settings-scroll-container", sectionIds);
        }
    }
    
    [JSInvokable]
    public void OnSectionVisible(string sectionId)
    {
        if (_activeSection != sectionId)
        {
            _activeSection = sectionId;
            StateHasChanged();
        }
    }
    
    private void BuildSectionsList()
    {
        _sections =
        [
            new SettingsSection("section-appearance", "Appearance", ApolloIcons.Appearance),
            new SettingsSection("section-themes", "Built-in Themes", ApolloIcons.Themes),
            new SettingsSection("section-custom-themes", "Custom Themes", ApolloIcons.CustomThemes),
            new SettingsSection("section-console", "Console", ApolloIcons.Console),
            new SettingsSection("section-code-analysis", "Code Analysis", ApolloIcons.Code),
            new SettingsSection("section-web-application", "Web Application", ApolloIcons.Web),
            new SettingsSection("section-keybindings", "Keyboard Shortcuts", ApolloIcons.Keyboard),
        ];
        
        foreach (var settingsGroup in Settings.GetSettingsModels())
        {
            _sections.Add(new SettingsSection(GetSectionId(settingsGroup.Section), settingsGroup.Section, ApolloIcons.Settings));
        }
    }
    
    private static string GetSectionId(string sectionName) => 
        $"section-{sectionName.ToLowerInvariant().Replace(" ", "-")}";
    
    private async Task ScrollToSection(string sectionId)
    {
        _activeSection = sectionId;
        await ScrollManager.ScrollToListItemAsync(sectionId);
    }
    
    private void OnThemesChanged() => InvokeAsync(StateHasChanged);
    
    public async void Dispose()
    {
        Settings.CustomThemes.OnThemesChanged -= OnThemesChanged;
        
        if (_jsModule != null)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("disposeScrollSpy");
            }
            catch
            {
                // Ignore errors during disposal
            }
        }
        
        _dotNetRef?.Dispose();
    }
    
    private string GetCurrentThemeValue()
    {
        if (Settings is { IsUsingCustomTheme: true, CurrentCustomThemeId: not null })
            return $"custom:{Settings.CurrentCustomThemeId}";
        
        return Settings.CurrentTheme.Name;
    }
    
    private void OnThemeSelected(string value)
    {
        if (value.StartsWith("custom:"))
        {
            var id = value[7..];
            var customTheme = Settings.CustomThemes.GetTheme(id);
            if (customTheme != null)
            {
                Settings.SetCustomTheme(customTheme);
            }
        }
        else
        {
            Settings.SetTheme(value);
        }
    }
    
    private async Task CreateNewTheme()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            NoHeader = true,
            MaxWidth = MaxWidth.Large
        };
        
        var parameters = new DialogParameters<ThemeCustomizer>
        {
            { x => x.BaseTheme, Settings.CurrentTheme }
        };
        
        var dialog = await DialogService.ShowAsync<ThemeCustomizer>("Create Theme", parameters, options);
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is CustomTheme newTheme)
        {
            Settings.SetCustomTheme(newTheme);
        }
    }
    
    private async Task EditTheme(CustomTheme theme)
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            NoHeader = true,
            MaxWidth = MaxWidth.Large
        };
        
        var parameters = new DialogParameters<ThemeCustomizer>
        {
            { x => x.ExistingTheme, theme }
        };
        
        var dialog = await DialogService.ShowAsync<ThemeCustomizer>("Edit Theme", parameters, options);
        var result = await dialog.Result;
        
        if (!result!.Canceled)
        {
            if (result.Data is CustomTheme updatedTheme)
            {
                Settings.SetCustomTheme(updatedTheme);
            }
            else if (Settings.CurrentCustomThemeId == theme.Data.Id)
            {
                Settings.SetTheme("Apollo");
            }
        }
    }
    
    private async Task ExportTheme(CustomTheme theme)
    {
        if (_jsModule == null) return;
        
        var json = Settings.CustomThemes.ExportTheme(theme.Data.Id);
        await _jsModule.InvokeVoidAsync("copyToClipboard", json);
        Snackbar.Add($"Theme '{theme.Name}' copied to clipboard!", Severity.Success);
    }
    
    private async Task ExportAllThemes()
    {
        if (_jsModule == null) return;
        
        var json = Settings.CustomThemes.ExportAllThemes();
        await _jsModule.InvokeVoidAsync("copyToClipboard", json);
        Snackbar.Add($"All {Settings.CustomThemes.Themes.Count} themes copied to clipboard!", Severity.Success);
    }
    
    private async Task ExportThemeToFile(CustomTheme theme)
    {
        var json = Settings.CustomThemes.ExportTheme(theme.Data.Id);
        var filename = $"{theme.Name.Replace(" ", "_")}_theme.json";
        await JsRuntime.SaveAs(filename, json);
        Snackbar.Add($"Theme '{theme.Name}' saved to file!", Severity.Success);
    }
    
    private async Task ExportAllThemesToFile()
    {
        var json = Settings.CustomThemes.ExportAllThemes();
        var filename = $"apollo_themes_{DateTime.Now:yyyyMMdd}.json";
        await JsRuntime.SaveAs(filename, json);
        Snackbar.Add($"All {Settings.CustomThemes.Themes.Count} themes saved to file!", Severity.Success);
    }
    
    private async Task ImportTheme()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium
        };
        
        var dialog = await DialogService.ShowAsync<ThemeImportDialog>("Import Theme", options);
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is CustomTheme importedTheme)
        {
            Settings.SetCustomTheme(importedTheme);
        }
    }
    
    private void Cancel() => MudDialog.Cancel();

    private async Task OnKeybindingChanged(KeyBinding binding)
    {
        await KeyBindingsState.UpdateKeyBindingAsync(binding);
        StateHasChanged();
    }

    private async Task OnKeybindingDeleted(KeyBinding binding)
    {
        await KeyBindingsState.DeleteKeyBindingAsync(binding);
        StateHasChanged();
    }

    private async Task ResetKeybindings()
    {
        await KeyBindingsState.ResetToDefaultsAsync();
        StateHasChanged();
    }

    private async Task AddNewKeybinding()
    {
        var newBinding = new KeyBinding
        {
            Id = Guid.NewGuid().ToString(),
            Key = default,
            Action = KeyBindingAction.None
        };
        await KeyBindingsState.UpdateKeyBindingAsync(newBinding);
        StateHasChanged();
    }
}
