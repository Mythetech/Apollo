@using System.Reflection
@using Apollo.Components.Analysis
@using Apollo.Components.Code
@using Apollo.Components.Console
@using Apollo.Components.Hosting
@using Apollo.Components.Infrastructure.MessageBus
@using Apollo.Components.Settings.Attributes
@using Apollo.Components.Settings.Events
@using Apollo.Components.Shared
@using Apollo.Components.Theme
@using Apollo.Components.Shared.ApolloSwitch
@using Microsoft.JSInterop
@using Apollo.Components.Shared
@implements IDisposable

<MudDialog Class="pa-4 glassmorphic" Style="width: 65vw; height: 75vh;">
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <MudText Class="app-header-font" Typo="Typo.h5">Settings</MudText>
            </MudItem>
            
            <MudItem xs="12">
                <MudText Class="mb-4 mud-text-secondary">Color Mode</MudText>
                <MudToggleGroup T="ThemeMode"
                                Value="@Settings.ThemeMode"
                                ValueChanged="@(value => Settings.ThemeMode = value)"
                                Color="Color.Secondary"
                                Class="d-flex mud-width-full">
                    <MudToggleItem Class="flex-grow-1" Value="@(ThemeMode.Light)">
                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Row Class="flex-grow-1 mud-width-full">
                            <MudIcon Icon="@Icons.Material.TwoTone.LightMode" Class="mr-2"/>
                            <MudText Style="@(Settings.ThemeMode == ThemeMode.Light ? "opacity: 1" : "opacity: 0.7")">
                                Light
                            </MudText>
                        </MudStack>
                    </MudToggleItem>
                    <MudToggleItem Class="flex-grow-1" Value="@(ThemeMode.Dark)">
                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Row Class="flex-grow-1 mud-width-full">
                            <MudIcon Icon="@Icons.Material.TwoTone.NightlightRound" Class="mr-2"/>
                            <MudText Style="@(Settings.ThemeMode == ThemeMode.Dark ? "opacity: 1" : "opacity: 0.7")">
                                Dark
                            </MudText>
                        </MudStack>
                    </MudToggleItem>
                    <MudToggleItem Class="flex-grow-1" Value="@(ThemeMode.System)">
                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Row Class="flex-grow-1 mud-width-full">
                            <MudIcon Icon="@Icons.Material.TwoTone.Computer" Class="mr-2"/>
                            <MudText Style="@(Settings.ThemeMode == ThemeMode.System ? "opacity: 1" : "opacity: 0.7")">
                                System
                            </MudText>
                        </MudStack>
                    </MudToggleItem>
                </MudToggleGroup>
            </MudItem>
            
            <MudItem xs="12">
                <MudDivider Class="my-4"/>
                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Class="mud-text-secondary">Built-in Themes</MudText>
                </MudStack>
                <MudToggleGroup T="string" 
                                Value="@GetCurrentThemeValue()"
                                ValueChanged="@OnThemeSelected"
                                Class="mud-width-full" 
                                SelectedClass="box-shadow-primary"
                                Style="border:none!important;">
                    <MudToggleItem Value="@("Apollo")" Class="rounded">
                        <ThemeCard 
                            Title="Apollo"
                            Description="Solar-inspired with golden accents"
                            ChipText="Default"
                            IsSelected="@(Settings.CurrentTheme.Name == "Apollo" && !Settings.IsUsingCustomTheme)"
                            CardTheme="@ApolloTheme.Instance.Theme.BaseTheme"/>
                    </MudToggleItem>
                    <MudToggleItem Value="@("Stealth")" Class="rounded">
                        <ThemeCard 
                            Title="Stealth"
                            Description="Minimalist flat design"
                            ChipText="Stealth"
                            IsSelected="@(Settings.CurrentTheme.Name == "Stealth" && !Settings.IsUsingCustomTheme)"
                            CardTheme="@StealthTheme.Instance.Theme.BaseTheme"/>
                    </MudToggleItem>
                    <MudToggleItem Value="@("Siren")" Class="rounded">
                        <ThemeCard
                            Title="Siren"
                            Description="Siren's signature blue theme"
                            ChipText="Siren"
                            IsSelected="@(Settings.CurrentTheme.Name == "Siren" && !Settings.IsUsingCustomTheme)"
                            CardTheme="@SirenTheme.Instance.Theme.BaseTheme"/>
                    </MudToggleItem>
                </MudToggleGroup>
            </MudItem>

            <MudItem xs="12">
                <MudDivider Class="my-4"/>
                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Class="mud-text-secondary">Custom Themes</MudText>
                    <MudStack Row Spacing="2">
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" StartIcon="@Icons.Material.TwoTone.ContentPaste" OnClick="ImportTheme">
                            Import
                        </MudButton>
                        @if (Settings.CustomThemes.Themes.Count > 0)
                        {
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" StartIcon="@ApolloIcons.Export" OnClick="ExportAllThemes">
                                Export All
                            </MudButton>
                        }
                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@ApolloIcons.Add" OnClick="CreateNewTheme">
                            New Theme
                        </MudButton>
                    </MudStack>
                </MudStack>
                
                @if (Settings.CustomThemes.Themes.Count == 0)
                {
                    <MudPaper Class="pa-4 d-flex flex-column align-center justify-center" Elevation="0" Style="background: var(--mud-palette-dark); min-height: 100px;">
                        <MudIcon Icon="@Icons.Material.TwoTone.Palette" Size="Size.Large" Class="mb-2 mud-text-secondary" />
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">No custom themes yet</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">Create or import a theme to get started</MudText>
                    </MudPaper>
                }
                else
                {
                    <MudToggleGroup T="string" 
                                    Value="@GetCurrentThemeValue()"
                                    ValueChanged="@OnThemeSelected"
                                    Class="mud-width-full" 
                                    SelectedClass="box-shadow-primary"
                                    Style="border:none!important;">
                        @foreach (var customTheme in Settings.CustomThemes.Themes.Values)
                        {
                            <MudToggleItem Value="@($"custom:{customTheme.Data.Id}")" Class="rounded">
                                <CustomThemeCard 
                                    Theme="@customTheme" 
                                    IsSelected="@(Settings.CurrentCustomThemeId == customTheme.Data.Id)"
                                    OnEdit="@(() => EditTheme(customTheme))"
                                    OnExport="@(() => ExportTheme(customTheme))" />
                            </MudToggleItem>
                        }
                    </MudToggleGroup>
                }
            </MudItem>

            <MudItem xs="12">
                <MudDivider Class="my-4"/>
                <MudText Class="mb-4 mud-text-secondary">Console Settings</MudText>
                <ApolloSwitch LabelPlacement="Placement.Left" Color="Color.Secondary" Label="Autoscroll when console input received" @bind-Value="ConsoleOutputService.AutoScroll" />
            </MudItem>

            <MudItem xs="12">
                <MudDivider Class="my-4"/>
                <MudText Class="mb-4 mud-text-secondary">Code Analysis Settings</MudText>
                <ApolloSwitch 
                    LabelPlacement="Placement.Left" 
                    Color="Color.Secondary" 
                    Label="Enable code analysis features (completions, diagnostics)" 
                    @bind-Value="@_codeAnalysisEnabled" />
                <ApolloSwitch
                    LabelPlacement="Placement.Left"
                    Color="Color.Secondary"
                    Label="Autoscroll when code analysis input received"
                    @bind-Value="CodeAnalysisConsoleService.AutoScroll" />
            </MudItem>

            <MudItem xs="12">
                <MudDivider Class="my-4"/>
                <MudText Class="mb-4 mud-text-secondary">Web Application Settings</MudText>
                <MudStack>
                    <ApolloSwitch 
                        LabelPlacement="Placement.Left" 
                        Color="Color.Secondary" 
                        Label="Autoscroll when web host output received" 
                        @bind-Value="WebHostConsoleService.AutoScroll" />
                </MudStack>
            </MudItem>
            
            @foreach (var settingsGroup in Settings.GetSettingsModels())
            {
                <MudItem xs="12">
                    <MudDivider Class="my-4"/>
                    <MudText Class="mb-4 mud-text-secondary">@settingsGroup.Section</MudText>
                    <MudStack>
                        @foreach (var property in settingsGroup.Type.GetProperties().Where(p => p.GetCustomAttribute<SettingAttribute>() != null))
                        {
                            var label = property.GetCustomAttribute<SettingAttribute>()?.Label;
                            
                            if (property.PropertyType == typeof(bool))
                            {
                                <ApolloSwitch
                                    LabelPlacement="Placement.Left"
                                    Color="Color.Secondary"
                                    Label="@label"
                                    Value="@((bool)property.GetValue(settingsGroup)!)"
                                    ValueChanged="@(async (bool value) => { property.SetValue(settingsGroup, value); await Bus.PublishAsync(new SettingsModelChanged(settingsGroup.Type, settingsGroup)); })"/>
                            }
                            else if (property.PropertyType == typeof(int))
                            {
                                <MudNumericField
                                    T="int"
                                    Label="@label"
                                    Variant="Variant.Outlined"
                                    Value="@((int)property.GetValue(settingsGroup)!)"
                                    ValueChanged="@(async (int value) => { property.SetValue(settingsGroup, value); await Bus.PublishAsync(new SettingsModelChanged(settingsGroup.Type, settingsGroup)); })"/>
                            }
                            else if (property.PropertyType.IsEnum)
                            {
                                <MudSelect
                                    T="string"
                                    Label="@label"
                                    Variant="Variant.Outlined"
                                    Value="@(property.GetValue(settingsGroup)!.ToString())"
                                    ValueChanged="@(async (string value) => { property.SetValue(settingsGroup, Enum.Parse(property.PropertyType, value)); await Bus.PublishAsync(new SettingsModelChanged(settingsGroup.Type, settingsGroup)); })">
                                    @foreach (var enumValue in Enum.GetNames(property.PropertyType))
                                    {
                                        <MudSelectItem Value="@enumValue">@enumValue</MudSelectItem>
                                    }
                                </MudSelect>
                            }
                        }
                    </MudStack>
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudStack Row="true" Spacing="4" Class="mud-width-full" AlignItems="AlignItems.Center">
            <MudSpacer/>
            <MudButton Class="rounded" OnClick="Cancel">Close</MudButton>
        </MudStack>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Inject] private SettingsState Settings { get; set; } = default!;
    [Inject] private ConsoleOutputService ConsoleOutputService { get; set; } = default!;
    [Inject] private CodeAnalysisState CodeAnalysisState { get; set; } = default!;
    [Inject] private WebHostConsoleService WebHostConsoleService { get; set; } = default!;
    [Inject] private CodeAnalysisConsoleService CodeAnalysisConsoleService { get; set; } = default!;
    [Inject] private IMessageBus Bus { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private IJSRuntime JsRuntime { get; set; } = default!;
    
    private IJSObjectReference? _jsModule;
    
    private bool _codeAnalysisEnabled
    {
        get => !CodeAnalysisState.Disabled;
        set => CodeAnalysisState.Disabled = !value;
    }
    
    protected override async Task OnInitializedAsync()
    {
        _jsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Apollo.Components/app.js");
        Settings.CustomThemes.OnThemesChanged += OnThemesChanged;
    }
    
    private void OnThemesChanged() => InvokeAsync(StateHasChanged);
    
    public void Dispose()
    {
        Settings.CustomThemes.OnThemesChanged -= OnThemesChanged;
    }
    
    private string GetCurrentThemeValue()
    {
        if (Settings.IsUsingCustomTheme && Settings.CurrentCustomThemeId != null)
            return $"custom:{Settings.CurrentCustomThemeId}";
        return Settings.CurrentTheme.Name;
    }
    
    private void OnThemeSelected(string value)
    {
        if (value.StartsWith("custom:"))
        {
            var id = value[7..];
            var customTheme = Settings.CustomThemes.GetTheme(id);
            if (customTheme != null)
            {
                Settings.SetCustomTheme(customTheme);
            }
        }
        else
        {
            Settings.SetTheme(value);
        }
    }
    
    private async Task CreateNewTheme()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            NoHeader = true,
            MaxWidth = MaxWidth.Large
        };
        
        var parameters = new DialogParameters<ThemeCustomizer>
        {
            { x => x.BaseTheme, Settings.CurrentTheme }
        };
        
        var dialog = await DialogService.ShowAsync<ThemeCustomizer>("Create Theme", parameters, options);
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is CustomTheme newTheme)
        {
            Settings.SetCustomTheme(newTheme);
        }
    }
    
    private async Task EditTheme(CustomTheme theme)
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            NoHeader = true,
            MaxWidth = MaxWidth.Large
        };
        
        var parameters = new DialogParameters<ThemeCustomizer>
        {
            { x => x.ExistingTheme, theme }
        };
        
        var dialog = await DialogService.ShowAsync<ThemeCustomizer>("Edit Theme", parameters, options);
        var result = await dialog.Result;
        
        if (!result!.Canceled)
        {
            if (result.Data is CustomTheme updatedTheme)
            {
                Settings.SetCustomTheme(updatedTheme);
            }
            else if (Settings.CurrentCustomThemeId == theme.Data.Id)
            {
                Settings.SetTheme("Apollo");
            }
        }
    }
    
    private async Task ExportTheme(CustomTheme theme)
    {
        if (_jsModule == null) return;
        
        var json = Settings.CustomThemes.ExportTheme(theme.Data.Id);
        await _jsModule.InvokeVoidAsync("copyToClipboard", json);
        Snackbar.Add($"Theme '{theme.Name}' copied to clipboard!", Severity.Success);
    }
    
    private async Task ExportAllThemes()
    {
        if (_jsModule == null) return;
        
        var json = Settings.CustomThemes.ExportAllThemes();
        await _jsModule.InvokeVoidAsync("copyToClipboard", json);
        Snackbar.Add($"All {Settings.CustomThemes.Themes.Count} themes copied to clipboard!", Severity.Success);
    }
    
    private async Task ExportThemeToFile(CustomTheme theme)
    {
        var json = Settings.CustomThemes.ExportTheme(theme.Data.Id);
        var filename = $"{theme.Name.Replace(" ", "_")}_theme.json";
        await JsRuntime.SaveAs(filename, json);
        Snackbar.Add($"Theme '{theme.Name}' saved to file!", Severity.Success);
    }
    
    private async Task ExportAllThemesToFile()
    {
        var json = Settings.CustomThemes.ExportAllThemes();
        var filename = $"apollo_themes_{DateTime.Now:yyyyMMdd}.json";
        await JsRuntime.SaveAs(filename, json);
        Snackbar.Add($"All {Settings.CustomThemes.Themes.Count} themes saved to file!", Severity.Success);
    }
    
    private async Task ImportTheme()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium
        };
        
        var dialog = await DialogService.ShowAsync<ThemeImportDialog>("Import Theme", options);
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is CustomTheme importedTheme)
        {
            Settings.SetCustomTheme(importedTheme);
        }
    }
    
    private void Cancel() => MudDialog.Cancel();
}
