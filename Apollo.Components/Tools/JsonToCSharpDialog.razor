@using Apollo.Components.Theme
@using Apollo.Components.Solutions
@using Apollo.Components.Shared
@using Apollo.Components.Shared.ApolloNotificationBar
@using BlazorMonaco
@using BlazorMonaco.Editor
@using MudBlazor
@implements IDisposable

<MudDialog Class="pa-4 glassmorphic" Style="width: 85vw; max-width: 1400px; height: 85vh;">
    <DialogContent>
        <MudGrid Style="height: 100%;">
            <MudItem xs="12">
                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <MudStack Spacing="0">
                        <MudText Class="app-header-font" Typo="Typo.h5">JSON to C# Converter</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">Convert JSON to C# classes</MudText>
                    </MudStack>
                    <MudStack Row Spacing="2">
                        <MudTextField @bind-Value="_rootClassName" 
                                      Label="Root Class Name" 
                                      Variant="Variant.Text" 
                                      Size="Size.Small"
                                      Style="width: 200px;"
                                      Immediate />
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" StartIcon="@ApolloIcons.Code" OnClick="ConvertToCSharp" Disabled="@string.IsNullOrWhiteSpace(_jsonInput)">
                            Convert
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" StartIcon="@ApolloIcons.Copy" OnClick="CopyCSharp" Disabled="@string.IsNullOrWhiteSpace(_csharpOutput)">
                            Copy
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" StartIcon="@ApolloIcons.Save" OnClick="SaveToSolution" Disabled="@string.IsNullOrWhiteSpace(_csharpOutput)">
                            Save to Solution
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" StartIcon="@ApolloIcons.Close" OnClick="Close">
                            Close
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudItem>

            @if (!string.IsNullOrEmpty(_error))
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Error" Dense Variant="Variant.Outlined">
                        <MudText Typo="Typo.body2">@_error</MudText>
                    </MudAlert>
                </MudItem>
            }

            <MudItem xs="12" md="6" Style="height: calc(85vh - 150px);">
                <MudStack Spacing="2" Style="height: 100%;">
                    <MudText Typo="Typo.subtitle2">Input JSON</MudText>
                    <MudPaper Elevation="0" Style="height: calc(100% - 40px); background: var(--mud-palette-dark);">
                        <StandaloneCodeEditor @ref="_inputEditor" 
                                               Id="json-to-csharp-input" 
                                               ConstructionOptions="@GetInputEditorOptions" 
                                               OnDidInit="OnInputEditorInit"
                                               OnDidChangeModelContent="OnInputEditorContentChanged" />
                    </MudPaper>
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="6" Style="height: calc(85vh - 150px);">
                <MudStack Spacing="2" Style="height: 100%;">
                    <MudText Typo="Typo.subtitle2">Generated C# Classes</MudText>
                    <MudPaper Elevation="0" Style="height: calc(100% - 40px); background: var(--mud-palette-dark);">
                        <StandaloneCodeEditor @ref="_outputEditor" 
                                               Id="json-to-csharp-output" 
                                               ConstructionOptions="@GetOutputEditorOptions" 
                                               OnDidInit="OnOutputEditorInit" />
                    </MudPaper>
                </MudStack>
            </MudItem>
        </MudGrid>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Inject] private IJsApiService JsApiService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private SolutionsState SolutionsState { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;

    private StandaloneCodeEditor? _inputEditor;
    private StandaloneCodeEditor? _outputEditor;
    private bool _inputEditorReady;
    private bool _outputEditorReady;

    private string _jsonInput = "";
    private string _csharpOutput = "";
    private string _rootClassName = "Root";
    private string? _error;

    private StandaloneEditorConstructionOptions GetInputEditorOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = "json",
            Value = _jsonInput,
            FontSize = 14,
            LineHeight = 20,
            TabSize = 2,
            InsertSpaces = true,
            WordWrap = "off",
            Minimap = new EditorMinimapOptions { Enabled = false },
        };
    }

    private StandaloneEditorConstructionOptions GetOutputEditorOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = "csharp",
            Value = _csharpOutput,
            FontSize = 14,
            LineHeight = 20,
            TabSize = 2,
            InsertSpaces = true,
            WordWrap = "off",
            Minimap = new EditorMinimapOptions { Enabled = false },
            ReadOnly = true,
        };
    }

    private async Task OnInputEditorInit()
    {
        _inputEditorReady = true;
        await Task.CompletedTask;
    }

    private async Task OnOutputEditorInit()
    {
        _outputEditorReady = true;
        await Task.CompletedTask;
    }

    private async Task OnInputEditorContentChanged(ModelContentChangedEvent evt)
    {
        if (!_inputEditorReady || _inputEditor == null)
            return;

        _jsonInput = await _inputEditor.GetValue();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ConvertToCSharp()
    {
        _error = null;
        _csharpOutput = "";

        if (!_inputEditorReady || _inputEditor == null)
            return;

        if (string.IsNullOrWhiteSpace(_jsonInput))
        {
            _jsonInput = await _inputEditor.GetValue();
        }

        if (string.IsNullOrWhiteSpace(_jsonInput))
        {
            _error = "Input is empty";
            return;
        }

        try
        {
            _csharpOutput = JsonToCSharpConverter.Convert(_jsonInput, _rootClassName);

            if (_outputEditorReady && _outputEditor != null)
            {
                await _outputEditor.SetValue(_csharpOutput);
            }
        }
        catch (Exception ex)
        {
            _error = $"Error converting JSON: {ex.Message}";
        }
    }

    private async Task CopyCSharp()
    {
        if (string.IsNullOrWhiteSpace(_csharpOutput))
            return;

        await JsApiService.CopyToClipboardAsync(_csharpOutput);
        Snackbar.AddApolloNotification("Copied C# classes to clipboard!", Severity.Success);
    }

    private async Task SaveToSolution()
    {
        if (string.IsNullOrWhiteSpace(_csharpOutput))
            return;

        var parameters = new DialogParameters
        {
            { "DefaultFileName", $"{_rootClassName}.cs" }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<SaveJsonFileDialog>("Save C# File", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string fileName && !string.IsNullOrWhiteSpace(fileName))
        {
            var csFileName = fileName.EndsWith(".cs", StringComparison.OrdinalIgnoreCase) ? fileName : $"{fileName}.cs";
            SolutionsState.AddFile(csFileName, _csharpOutput);
            Snackbar.AddApolloNotification($"Saved {csFileName} to solution!", Severity.Success);
        }
    }

    private void Close() => MudDialog.Close();

    public void Dispose()
    {
    }
}

