@using Apollo.Components
@using Apollo.Components.Code
@using Apollo.Components.Infrastructure.Keyboard
@using Apollo.Components.NuGet
@using Apollo.Components.Settings
@using Apollo.Components.Theme
@using Microsoft.FluentUI.AspNetCore.Components
@inherits LayoutComponentBase
@implements IDisposable

<PageTitle>Apollo</PageTitle>

<MudLayout>
    <MudAppBar Elevation="0">
        <MudSpacer />
        <SettingsButton />
    </MudAppBar>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

<MudThemeProvider Theme="@GetCurrentTheme()" IsDarkMode="@State.IsDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<FluentKeyCodeProvider />
@code {
    [Inject] public IJSRuntime JsRuntime { get; set; }

    [Inject] public AppState State { get; set; } = default!;

    [Inject] public SettingsState Settings { get; set; } = default!;

    [Inject] public KeyBindingsState KeyBindings { get; set; } = default!;

    [Inject] public NuGetState NuGetState { get; set; } = default!;

    bool _drawerOpen = true;

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override void OnInitialized()
    {
        State.AppStateChanged += HandleAppStateChanged;
    }

    public void Dispose()
    {
        State.AppStateChanged -= HandleAppStateChanged;
    }

    protected async void HandleAppStateChanged()
    {
        await JsRuntime.InvokeVoidAsync("apolloEditor.setTheme", State.IsDarkMode);
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JsRuntime.InvokeVoidAsync("apolloEditor.setTheme", State.IsDarkMode);
            await Settings.TryLoadSettingsFromStorageAsync();
            await Settings.TrySetSystemThemeAsync();
            await KeyBindings.LoadFromStorageAsync();
            await NuGetState.InitializeAsync();
        }
    }

    private MudTheme GetCurrentTheme()
    {
        return Settings.CurrentTheme.BaseTheme;
    }

}